---
title: "Heaton's Method on New Data from Pellicer Creek"
output: html_notebook
---

```{r}
library(tidyverse)
library(magrittr)
library(reshape2)
library(HDInterval)
library(readxl)
```

Determinations:
Get the original HOBS data
```{r}

HOBSGeo_Apps_202208_final = read_xlsx("HOBSGeo_Apps_202208_final.xlsx", sheet = "DR3", skip = 31 )
HOBSGeo_Apps_202208_final %>% filter(Locality == "Pellicer Creek" & Depth == "25-35cm" ) -> PC_Old

PC_Old %<>% filter(Station == 8933) %>% select(Cat_No,F14C_corr,F14C_corr_sd)
names(PC_Old) = c("name", "F14C_corr","F14C_corr_sd")
```

Get the new samples

```{r}
Durham_GAS_April24_2023 = read_xlsx("Durham_GAS 14C results_April 24 2023.xlsx", skip = 1)
Durham_GAS_April24_2023 %<>% select("Sample ID", "Modern","Â±...5")
Durham_GAS_April24_2023 %<>% na.omit()
names(Durham_GAS_April24_2023) = c("name", "F14C_corr","F14C_corr_sd")
Durham_GAS_April24_2023 %<>% mutate(Sample_code = as.character(data.frame(strsplit(name, " "))[1,]))
Durham_GAS_April24_2023 %>% filter(grepl("PC_R3H2S2", name)) -> PC_New

PC_New %<>% select(name, F14C_corr,F14C_corr_sd)
```


Curve
```{r}
#Curve = read.csv("/Users/johnhandley/Documents/PaleontologyResearch/Oysters/HOBS/Contract work/Comparisons/Kowalewski_NP/Curves/bombBahamasto10000calBP.14c", sep = "\t")
#names(Curve) = c("Year", "D14C", "D14Csd", "F14C", "F14Csd")
Curve = read.csv("HOBS_14C_CalCurve_PredictedVals_20230524.csv")

Curve %<>% mutate(Year = year, D14C = NA, D14Csd = NA, F14C = estimate, F14Csd = esterror) %>% select(-contains(c("q", "est"))) %>% select(-year)
```



Let's see if we can run through some random samples with Heaton's code

```{r}
source("WalkerNonParametricCalibration.R")
source("Utilities.R")
PC_All  = as.data.frame(rbind(PC_Old,PC_New))

PC_All_names = PC_All$name
PC_All_NP_results = data.frame()
set.seed(1234)
system.time(
for( n in seq(3,length(PC_All_names), by = 1)){ 
     for( ii in 1:30){ 
        random_sample = sample(PC_All_names, size = n, replace = FALSE)
        # get the factions for these samples
        tmp = PC_All %>% filter(name %in% random_sample)
        NP = WalkerNonParametricCalibration(Curve = Curve, Determinations = tmp)
        NP %<>% select(calage, NonParametric)
        names(NP) = c("year","probability")
        NP$year = 2020-NP$year
        PC_All_NP_results = rbind(PC_All_NP_results, data.frame( n = n, NP_IQR = Posterior_IQR(NP), NP_95 = Posterior_IQR(NP, lo = 0.025, hi = 0.975), NP_HDI = HDI(NP), Median = Median(NP)))
     }
}
)

```

```{r}
write_rds(PC_All_NP_results, "PC_All_NP_results.RDS")
```
```{r}
PC_All_NP_results %>% reshape2::melt("n") %>% ggplot(aes(x = n, y = value)) + geom_jitter(width = 0.2, alpha =0.5, size = 0.5) + geom_smooth(color = "orange") + facet_wrap(~variable) + ggtitle("Pellicer Creek")
```